# Path A: Bindable Variables

Use when: Single app per database, standard CRUD applications.

## How It Works

When you create users via DigitalOcean's interface (Console, API, or `doctl`), **DO stores the credentials internally**. App Platform can then automatically retrieve these credentials and populate bindable environment variables.

```
┌─────────────────────────────────────────────────────────────────┐
│                    DigitalOcean Internal Systems                │
│  ┌─────────────────┐         ┌─────────────────────────────┐   │
│  │ Managed Database │         │   Credential Store          │   │
│  │    Cluster       │         │   (users created via DO)    │   │
│  │                  │         │                             │   │
│  │  - doadmin       │◄───────►│  doadmin: <auto-generated>  │   │
│  │  - myappuser     │         │  myappuser: <auto-generated>│   │
│  └─────────────────┘         └──────────────▲──────────────┘   │
│                                              │                  │
│  ┌─────────────────┐                         │                  │
│  │   App Platform   │─────────────────────────┘                  │
│  │                  │  Queries credentials by                   │
│  │  app spec:       │  cluster_name + db_user                   │
│  │  - cluster_name  │                                           │
│  │  - db_user       │──────► Populates ${db.DATABASE_URL}       │
│  └─────────────────┘                                            │
└─────────────────────────────────────────────────────────────────┘
```

## Step-by-Step Setup

### Step 1: Create cluster, database, and user via doctl

```bash
# Create cluster (or use existing)
doctl databases create my-app-db \
  --engine pg \
  --region nyc3 \
  --size db-s-1vcpu-2gb \
  --version 16

# Get cluster ID
CLUSTER_ID=$(doctl databases list --format ID,Name --no-header | grep my-app-db | awk '{print $1}')

# Create database within cluster
doctl databases db create $CLUSTER_ID myappdb

# Create user (DO generates and stores the password - you never see it)
doctl databases user create $CLUSTER_ID myappuser

# Verify
doctl databases user list $CLUSTER_ID
doctl databases db list $CLUSTER_ID
```

### Step 2: Grant permissions (REQUIRED)

Even though DO manages the password, the user has NO permissions by default.

```bash
# Get admin connection string
ADMIN_URL=$(doctl databases connection $CLUSTER_ID --format Uri --no-header)

# Connect as doadmin and grant permissions
psql "$ADMIN_URL" << 'EOF'
GRANT CONNECT ON DATABASE myappdb TO myappuser;
\c myappdb
GRANT USAGE ON SCHEMA public TO myappuser;
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO myappuser;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO myappuser;
ALTER DEFAULT PRIVILEGES IN SCHEMA public
  GRANT ALL ON TABLES TO myappuser;
ALTER DEFAULT PRIVILEGES IN SCHEMA public
  GRANT ALL ON SEQUENCES TO myappuser;
EOF
```

**Permission SQL template** (`db-permissions-path-a.sql`):
```sql
-- Run as doadmin after creating user via doctl
GRANT CONNECT ON DATABASE {db_name} TO {username};
\c {db_name}
GRANT USAGE ON SCHEMA public TO {username};
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO {username};
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO {username};
ALTER DEFAULT PRIVILEGES IN SCHEMA public
  GRANT ALL ON TABLES TO {username};
ALTER DEFAULT PRIVILEGES IN SCHEMA public
  GRANT ALL ON SEQUENCES TO {username};
```

### Step 3: Reference in app spec

```yaml
# .do/app.yaml
databases:
  - name: db
    engine: PG
    production: true            # REQUIRED for managed databases
    cluster_name: my-app-db     # Must match existing cluster name
    db_name: myappdb
    db_user: myappuser

services:
  - name: api
    envs:
      - key: DATABASE_URL
        scope: RUN_TIME
        value: ${db.DATABASE_URL}
```

### Step 4: Deploy and verify

```bash
doctl apps create --spec .do/app.yaml

# Verify bindable variables are populated (in running container):
echo $DATABASE_URL
# Should output: postgresql://myappuser:AVNS_xxx@host:25060/myappdb?sslmode=require
```

## Critical Requirements

| Requirement | Why |
|-------------|-----|
| User created via DO interface | DO must have the password stored internally |
| `production: true` in app spec | Tells App Platform this is a managed database |
| `cluster_name` matches exactly | App Platform looks up the cluster by name |
| Cluster must exist before deploy | Unlike dev DBs, managed DBs aren't auto-created |
| **Permissions granted via doadmin** | Users have no access by default! |

## What Does NOT Work

- **Users created via raw SQL** - App Platform cannot retrieve passwords for SQL-created users
- **External databases** - Bindable variables only work with DO Managed Databases

## Connection Pools

```yaml
envs:
  - key: DATABASE_POOL_URL
    scope: RUN_TIME
    value: ${db.my-pool-name.DATABASE_URL}
```

Create pool via:
```bash
doctl databases pool create $CLUSTER_ID my-pool-name \
  --db myappdb \
  --mode transaction \
  --size 25 \
  --user myappuser
```

## Multi-App on One Cluster (Separate Databases)

Each app gets its own database within the cluster:

```bash
# For each app:
doctl databases db create $CLUSTER_ID app1db
doctl databases user create $CLUSTER_ID app1user

doctl databases db create $CLUSTER_ID app2db
doctl databases user create $CLUSTER_ID app2user
```

App spec:
```yaml
databases:
  - name: app1
    engine: PG
    production: true
    cluster_name: my-cluster
    db_name: app1db
    db_user: app1user
  - name: app2
    engine: PG
    production: true
    cluster_name: my-cluster
    db_name: app2db
    db_user: app2user

services:
  - name: app1-api
    envs:
      - key: DATABASE_URL
        value: ${app1.DATABASE_URL}
  - name: app2-api
    envs:
      - key: DATABASE_URL
        value: ${app2.DATABASE_URL}
```

## Read-Only User

```bash
doctl databases user create $CLUSTER_ID myappreader
```

Permissions:
```sql
GRANT CONNECT ON DATABASE myappdb TO myappreader;
\c myappdb
GRANT USAGE ON SCHEMA public TO myappreader;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO myappreader;
ALTER DEFAULT PRIVILEGES IN SCHEMA public
  GRANT SELECT ON TABLES TO myappreader;
```

App spec:
```yaml
databases:
  - name: readonly
    engine: PG
    production: true
    cluster_name: my-cluster
    db_name: myappdb
    db_user: myappreader

services:
  - name: analytics
    envs:
      - key: DATABASE_URL
        value: ${readonly.DATABASE_URL}
```
